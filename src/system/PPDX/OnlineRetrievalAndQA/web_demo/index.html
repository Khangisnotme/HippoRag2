<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PPDX - Memory-Augmented QA System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header .subtitle {
            color: #7f8c8d;
            font-size: 1.2em;
            margin-bottom: 15px;
        }

        .header .info {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
            margin-top: 20px;
            font-size: 0.9em;
            color: #34495e;
        }

        .main-card {
            background: white;
            border-radius: 15px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .question-section {
            margin-bottom: 30px;
        }

        .question-section label {
            display: block;
            font-size: 1.2em;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .question-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e6ed;
            border-radius: 10px;
            font-size: 1.1em;
            resize: vertical;
            min-height: 80px;
            transition: border-color 0.3s;
        }

        .question-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .settings-section {
            display: flex;
            gap: 30px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            align-items: center;
        }

        .setting-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .setting-item label {
            font-weight: 500;
            color: #34495e;
        }

        .setting-item select {
            padding: 8px 12px;
            border: 2px solid #e0e6ed;
            border-radius: 6px;
            font-size: 1em;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
            background: #ddd;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch.active {
            background: #3498db;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.3s;
        }

        .toggle-switch.active::after {
            transform: translateX(26px);
        }

        .process-btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.2em;
            font-weight: 600;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: block;
            margin: 0 auto;
        }

        .process-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(52, 152, 219, 0.3);
        }

        .process-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .status-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .status-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border-left: 4px solid #28a745;
        }

        .status-item.checking {
            border-left-color: #ffc107;
        }

        .status-item.error {
            border-left-color: #dc3545;
        }

        .status-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .status-text {
            font-weight: 600;
            color: #2c3e50;
        }

        .processing-view {
            display: none;
        }

        .processing-view.active {
            display: block;
        }

        .pipeline-status {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
        }

        .module-item {
            display: flex;
            align-items: center;
            padding: 20px;
            margin: 10px 0;
            border-radius: 10px;
            background: #f8f9fa;
            transition: all 0.3s;
        }

        .module-item.active {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
        }

        .module-item.completed {
            background: #e8f5e8;
            border-left: 4px solid #4caf50;
        }

        .module-icon {
            font-size: 1.8em;
            margin-right: 15px;
            width: 40px;
        }

        .module-content {
            flex: 1;
        }

        .module-title {
            font-weight: 600;
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .module-status {
            color: #6c757d;
            font-size: 0.9em;
        }

        .module-time {
            font-weight: 600;
            color: #28a745;
            margin-left: 10px;
        }

        .progress-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2980b9);
            transition: width 0.5s ease;
            border-radius: 10px;
        }

        .progress-text {
            text-align: center;
            font-weight: 600;
            color: #2c3e50;
        }

        .cancel-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 20px;
        }

        .results-view {
            display: none;
        }

        .results-view.active {
            display: block;
        }

        .answer-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .answer-content {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            border-left: 4px solid #28a745;
            margin: 20px 0;
        }

        .answer-text {
            font-size: 1.1em;
            line-height: 1.6;
            color: #2c3e50;
            margin-bottom: 20px;
        }

        .answer-metrics {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
        }

        .metric-item {
            text-align: center;
        }

        .metric-value {
            font-size: 1.5em;
            font-weight: 700;
            color: #3498db;
        }

        .metric-label {
            font-size: 0.9em;
            color: #6c757d;
        }

        .passages-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .passage-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid #ffc107;
        }

        .passage-item:first-child {
            border-left-color: #ffd700;
        }

        .passage-item:nth-child(2) {
            border-left-color: #c0c0c0;
        }

        .passage-item:nth-child(3) {
            border-left-color: #cd7f32;
        }

        .passage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .passage-rank {
            font-weight: 700;
            font-size: 1.1em;
        }

        .passage-score {
            background: #3498db;
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .passage-text {
            color: #34495e;
            line-height: 1.5;
            margin-bottom: 10px;
        }

        .passage-meta {
            font-size: 0.85em;
            color: #6c757d;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .sample-questions {
            margin-bottom: 20px;
        }

        .sample-question-btn {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            margin: 5px;
            transition: all 0.3s;
        }

        .sample-question-btn:hover {
            background: #e9ecef;
            border-color: #adb5bd;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #f5c6cb;
        }

        /* Detailed Results Styling */
        .detailed-results {
            margin-top: 30px;
        }

        .module-detail-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-left: 4px solid #3498db;
        }

        .module-detail-card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .module-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }

        .stat-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.3em;
            font-weight: 700;
            color: #3498db;
        }

        .stat-label {
            font-size: 0.9em;
            color: #6c757d;
            margin-top: 5px;
        }

        .data-list {
            max-height: 300px;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
        }

        .data-item {
            background: white;
            padding: 12px;
            margin: 8px 0;
            border-radius: 6px;
            border-left: 3px solid #28a745;
        }

        .data-item-header {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .data-item-content {
            color: #34495e;
            font-size: 0.9em;
        }

        .toggle-details-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px 5px;
            transition: all 0.3s;
        }

        .toggle-details-btn:hover {
            background: #138496;
            transform: translateY(-1px);
        }

        .collapsible {
            display: none;
        }

        .collapsible.show {
            display: block;
        }

        @media (max-width: 768px) {
            .header .info {
                flex-direction: column;
                gap: 10px;
            }
            
            .settings-section {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .answer-metrics {
                justify-content: center;
            }

            .module-stats {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            }
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>🎓 HUST Graduation Thesis Demo</h1>
            <div class="subtitle">💡 PPDX: Memory-Augmented Information Extraction System</div>
            <div class="info">
                <div>👨‍🎓 Student: Doan Ngoc Cuong (20210141)</div>
                <div>👩‍🏫 Supervisor: Assoc. Prof. Nguyen Thi Kim Anh</div>
                <div>📅 Date: June 2025</div>
            </div>
        </div>

        <!-- Main Interface -->
        <div id="main-view" class="main-card">
            <!-- Sample Questions -->
            <div class="sample-questions">
                <div style="margin-bottom: 10px; font-weight: 600; color: #2c3e50;">
                    💡 Try these sample questions:
                </div>
                <div id="sample-questions-container">
                    <!-- Sample questions will be populated by JavaScript -->
                </div>
            </div>

            <div class="question-section">
                <label>💭 Ask your question:</label>
                <textarea 
                    id="question-input" 
                    class="question-input" 
                    placeholder="What are the health benefits of green apples?"
                >What are the health benefits of green apples?</textarea>
            </div>

            <div class="settings-section">
                <div class="setting-item">
                    <label>Max Passages:</label>
                    <select id="max-passages">
                        <option value="5">5</option>
                        <option value="10" selected>10</option>
                        <option value="15">15</option>
                        <option value="20">20</option>
                    </select>
                </div>
                <div class="setting-item">
                    <label>Enable Answer Generation:</label>
                    <div id="answer-toggle" class="toggle-switch active"></div>
                </div>
                <div class="setting-item">
                    <label>Enable Context Expansion:</label>
                    <div id="expansion-toggle" class="toggle-switch"></div>
                </div>
            </div>

            <button id="process-btn" class="process-btn">🔍 Process Question</button>

            <div class="status-section">
                <div id="neo4j-status" class="status-item checking">
                    <div class="status-icon">🗃️</div>
                    <div class="status-text">Neo4j Database</div>
                    <div>Checking...</div>
                </div>
                <div id="vector-status" class="status-item checking">
                    <div class="status-icon">🧠</div>
                    <div class="status-text">Vector Database</div>
                    <div>Checking...</div>
                </div>
                <div id="llm-status" class="status-item checking">
                    <div class="status-icon">🤖</div>
                    <div class="status-text">LLM Service</div>
                    <div>Checking...</div>
                </div>
            </div>

            <div id="error-container"></div>
        </div>

        <!-- Processing View -->
        <div id="processing-view" class="processing-view">
            <div class="pipeline-status">
                <h2 style="text-align: center; margin-bottom: 30px; color: #2c3e50;">
                    🔄 Processing Pipeline
                </h2>
                <div id="current-query" style="text-align: center; margin-bottom: 30px; font-style: italic; color: #6c757d;"></div>

                <div id="module1" class="module-item">
                    <div class="module-icon">📊</div>
                    <div class="module-content">
                        <div class="module-title">Module 1: Dual Retrieval</div>
                        <div class="module-status">Waiting to start...</div>
                    </div>
                </div>

                <div id="module2" class="module-item">
                    <div class="module-icon">🤖</div>
                    <div class="module-content">
                        <div class="module-title">Module 2: LLM Triple Filtering</div>
                        <div class="module-status">Waiting for Module 1...</div>
                    </div>
                </div>

                <div id="module3" class="module-item">
                    <div class="module-icon">🏆</div>
                    <div class="module-content">
                        <div class="module-title">Module 3: Passage Ranking</div>
                        <div class="module-status">Waiting for Module 2...</div>
                    </div>
                </div>

                <div id="module4" class="module-item">
                    <div class="module-icon">🔗</div>
                    <div class="module-content">
                        <div class="module-title">Module 4: Context Expansion</div>
                        <div class="module-status">Optional - Will run if enabled</div>
                    </div>
                </div>

                <div id="module5" class="module-item">
                    <div class="module-icon">💬</div>
                    <div class="module-content">
                        <div class="module-title">Module 5: Answer Generation</div>
                        <div class="module-status">Waiting for previous modules...</div>
                    </div>
                </div>
            </div>

            <div class="progress-section">
                <div class="progress-bar">
                    <div id="progress-fill" class="progress-fill" style="width: 0%"></div>
                </div>
                <div id="progress-text" class="progress-text">Starting processing...</div>
                <div style="text-align: center; margin-top: 15px;">
                    <span id="elapsed-time">⏱️ Elapsed: 0s</span>
                    <span style="margin: 0 20px;">|</span>
                    <span id="estimated-time">🕐 Estimated: calculating...</span>
                </div>
                <button id="cancel-btn" class="cancel-btn">⏹️ Cancel Processing</button>
            </div>
        </div>

        <!-- Results View -->
        <div id="results-view" class="results-view">
            <div class="answer-section">
                <h2 style="color: #2c3e50; margin-bottom: 20px;">💬 AI Generated Answer</h2>
                <div id="processing-time" style="text-align: center; color: #6c757d; margin-bottom: 20px;"></div>
                
                <div class="answer-content">
                    <div id="answer-text" class="answer-text"></div>
                    <div class="answer-metrics">
                        <div class="metric-item">
                            <div id="quality-score" class="metric-value">8.7</div>
                            <div class="metric-label">Quality Score</div>
                        </div>
                        <div class="metric-item">
                            <div id="confidence-score" class="metric-value">92%</div>
                            <div class="metric-label">Confidence</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="passages-section">
                <h2 style="color: #2c3e50; margin-bottom: 20px;">📄 Top Supporting Passages</h2>
                <div id="passages-container"></div>
            </div>

            <div class="action-buttons">
                <button id="view-details-btn" class="action-btn btn-primary">📊 View Module Details</button>
                <button id="ask-another-btn" class="action-btn btn-secondary">🔄 Ask Another</button>
                <button id="save-result-btn" class="action-btn btn-success">💾 Save Result</button>
            </div>
        </div>

        <!-- Detailed Results View -->
        <div id="detailed-results" class="detailed-results" style="display: none;">
            <div class="main-card">
                <button id="back-to-results-btn" class="action-btn btn-secondary" style="margin-bottom: 20px;">◀️ Back to Results</button>
                
                <h2 style="color: #2c3e50; margin-bottom: 20px; text-align: center;">
                    📊 Detailed Pipeline Analysis
                </h2>
                
                <div style="text-align: center; margin-bottom: 20px;">
                    <button id="toggle-module1-btn" class="toggle-details-btn">📊 Module 1: Dual Retrieval</button>
                    <button id="toggle-module2-btn" class="toggle-details-btn">🤖 Module 2: Triple Filtering</button>
                    <button id="toggle-module3-btn" class="toggle-details-btn">🏆 Module 3: Passage Ranking</button>
                    <button id="toggle-module5-btn" class="toggle-details-btn">💬 Module 5: Answer Generation</button>
                </div>

                <!-- Module 1 Details -->
                <div id="module1-details" class="module-detail-card collapsible">
                    <h3>📊 Module 1: Dual Retrieval</h3>
                    <div id="module1-stats" class="module-stats"></div>
                    <div>
                        <h4>Top Retrieved Passages:</h4>
                        <div id="module1-passages" class="data-list"></div>
                    </div>
                    <div>
                        <h4>Top Retrieved Triples:</h4>
                        <div id="module1-triples" class="data-list"></div>
                    </div>
                </div>

                <!-- Module 2 Details -->
                <div id="module2-details" class="module-detail-card collapsible">
                    <h3>🤖 Module 2: LLM Triple Filtering</h3>
                    <div id="module2-stats" class="module-stats"></div>
                    <div>
                        <h4>Filtered Triples:</h4>
                        <div id="module2-triples" class="data-list"></div>
                    </div>
                </div>

                <!-- Module 3 Details -->
                <div id="module3-details" class="module-detail-card collapsible">
                    <h3>🏆 Module 3: Passage Ranking</h3>
                    <div id="module3-stats" class="module-stats"></div>
                    <div>
                        <h4>Ranked Passages:</h4>
                        <div id="module3-passages" class="data-list"></div>
                    </div>
                </div>

                <!-- Module 5 Details -->
                <div id="module5-details" class="module-detail-card collapsible">
                    <h3>💬 Module 5: Answer Generation</h3>
                    <div id="module5-stats" class="module-stats"></div>
                    <div>
                        <h4>Generation Details:</h4>
                        <div id="module5-details-content" class="data-list"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentView = 'main';
        let currentQuery = '';
        let processingWebSocket = null;
        let answerGenEnabled = true;
        let contextExpansionEnabled = false;
        let isProcessing = false;
        let currentDetailedResults = null;

        // DOM elements
        const questionInput = document.getElementById('question-input');
        const maxPassagesSelect = document.getElementById('max-passages');
        const answerToggle = document.getElementById('answer-toggle');
        const expansionToggle = document.getElementById('expansion-toggle');
        const processBtn = document.getElementById('process-btn');
        const cancelBtn = document.getElementById('cancel-btn');

        // Views
        const mainView = document.getElementById('main-view');
        const processingView = document.getElementById('processing-view');
        const resultsView = document.getElementById('results-view');

        // Sample questions
        const sampleQuestions = [
            "What are the health benefits of green apples?",
            "How does machine learning improve healthcare outcomes?",
            "What are the environmental impacts of renewable energy?",
            "How can artificial intelligence help in education?",
            "What are the benefits of regular exercise for mental health?"
        ];

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupEventListeners();
            checkSystemStatus();
            populateSampleQuestions();
        });

        function initializeApp() {
            showView('main');
        }

        function setupEventListeners() {
            // Toggle switches
            answerToggle.addEventListener('click', function() {
                answerGenEnabled = !answerGenEnabled;
                answerToggle.classList.toggle('active', answerGenEnabled);
            });

            expansionToggle.addEventListener('click', function() {
                contextExpansionEnabled = !contextExpansionEnabled;
                expansionToggle.classList.toggle('active', contextExpansionEnabled);
            });

            // Process button
            processBtn.addEventListener('click', startProcessing);

            // Cancel button
            cancelBtn.addEventListener('click', cancelProcessing);

            // Navigation buttons
            document.getElementById('view-details-btn').addEventListener('click', showDetailedResults);
            document.getElementById('ask-another-btn').addEventListener('click', () => showView('main'));
            document.getElementById('save-result-btn').addEventListener('click', saveResults);
            document.getElementById('back-to-results-btn').addEventListener('click', () => showView('results'));

            // Toggle buttons for modules
            document.getElementById('toggle-module1-btn').addEventListener('click', () => toggleModule('module1'));
            document.getElementById('toggle-module2-btn').addEventListener('click', () => toggleModule('module2'));
            document.getElementById('toggle-module3-btn').addEventListener('click', () => toggleModule('module3'));
            document.getElementById('toggle-module5-btn').addEventListener('click', () => toggleModule('module5'));
        }

        function populateSampleQuestions() {
            const container = document.getElementById('sample-questions-container');
            container.innerHTML = sampleQuestions.map(q => `
                <button class="sample-question-btn" onclick="selectSampleQuestion('${q.replace(/'/g, "\\'")}')">
                    ${q.length > 40 ? q.substring(0, 40) + '...' : q}
                </button>
            `).join('');
        }

        function selectSampleQuestion(question) {
            questionInput.value = question;
            
            // Highlight selected button briefly
            const buttons = document.querySelectorAll('.sample-question-btn');
            buttons.forEach(btn => {
                if (btn.textContent.includes(question.substring(0, 30))) {
                    btn.style.background = '#e3f2fd';
                    btn.style.borderColor = '#2196f3';
                    setTimeout(() => {
                        btn.style.background = '#f8f9fa';
                        btn.style.borderColor = '#dee2e6';
                    }, 1000);
                }
            });
        }

        function showView(viewName) {
            // Hide all views
            mainView.style.display = 'none';
            processingView.style.display = 'none';
            resultsView.style.display = 'none';
            document.getElementById('detailed-results').style.display = 'none';

            // Show selected view
            currentView = viewName;
            switch(viewName) {
                case 'main':
                    mainView.style.display = 'block';
                    break;
                case 'processing':
                    processingView.style.display = 'block';
                    break;
                case 'results':
                    resultsView.style.display = 'block';
                    break;
                case 'detailed':
                    document.getElementById('detailed-results').style.display = 'block';
                    break;
            }
        }

        async function checkSystemStatus() {
            try {
                const response = await fetch('/api/health');
                const status = await response.json();
                
                updateStatusItem('neo4j-status', status.neo4j);
                updateStatusItem('vector-status', status.vector_db);
                updateStatusItem('llm-status', status.llm_service);
                
            } catch (error) {
                console.error('Failed to check system status:', error);
                updateStatusItem('neo4j-status', 'error');
                updateStatusItem('vector-status', 'error');
                updateStatusItem('llm-status', 'error');
            }
        }

        function updateStatusItem(elementId, status) {
            const element = document.getElementById(elementId);
            element.classList.remove('checking', 'error');
            
            if (status === 'connected' || status === 'ready' || status === 'available') {
                element.classList.add('connected');
                element.querySelector('div:last-child').textContent = 'Connected';
            } else {
                element.classList.add('error');
                element.querySelector('div:last-child').textContent = 'Error';
            }
        }

        async function startProcessing() {
            const query = questionInput.value.trim();
            if (!query) {
                showError('Please enter a question');
                return;
            }

            if (isProcessing) {
                return;
            }

            currentQuery = query;
            isProcessing = true;
            processBtn.disabled = true;
            document.getElementById('current-query').textContent = `"${query}"`;
            
            showView('processing');
            
            try {
                // Try WebSocket first, fallback to HTTP
                if (window.WebSocket) {
                    await processWithWebSocket(query);
                } else {
                    await processWithHTTP(query);
                }
            } catch (error) {
                console.error('Processing failed:', error);
                showError('Processing failed: ' + error.message);
                showView('main');
            } finally {
                isProcessing = false;
                processBtn.disabled = false;
            }
        }

        async function processWithWebSocket(query) {
            return new Promise((resolve, reject) => {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/ws/process`;
                
                processingWebSocket = new WebSocket(wsUrl);
                
                processingWebSocket.onopen = () => {
                    console.log('WebSocket connected');
                    processingWebSocket.send(JSON.stringify({
                        question: query,
                        max_passages: parseInt(maxPassagesSelect.value),
                        enable_answer_generation: answerGenEnabled,
                        enable_context_expansion: contextExpansionEnabled
                    }));
                };
                
                processingWebSocket.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    
                    switch(data.type) {
                        case 'start':
                            resetModuleStates();
                            break;
                        case 'module_start':
                            updateModuleStatus(data.module, 'active', data.message);
                            break;
                        case 'module_complete':
                            updateModuleStatus(data.module, 'completed', `Completed (${data.time}s)`);
                            updateProgress(data.progress || 0);
                            break;
                        case 'complete':
                            displayResults(data.result);
                            processingWebSocket.close();
                            resolve();
                            break;
                        case 'error':
                            showError(data.message);
                            processingWebSocket.close();
                            reject(new Error(data.message));
                            break;
                    }
                };
                
                processingWebSocket.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    processingWebSocket.close();
                    // Fallback to HTTP
                    processWithHTTP(query).then(resolve).catch(reject);
                };
                
                processingWebSocket.onclose = () => {
                    console.log('WebSocket closed');
                };
            });
        }

        async function processWithHTTP(query) {
            console.log('Using HTTP fallback');
            
            // Simulate processing updates
            resetModuleStates();
            simulateProcessingUpdates();
            
            try {
                const response = await fetch('/api/process', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        question: query,
                        max_passages: parseInt(maxPassagesSelect.value),
                        enable_answer_generation: answerGenEnabled,
                        enable_context_expansion: contextExpansionEnabled
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                displayResults(result);
                
            } catch (error) {
                console.error('HTTP request failed:', error);
                throw error;
            }
        }

        function simulateProcessingUpdates() {
            const modules = [
                {id: 'module1', name: 'Dual Retrieval', time: 2.3},
                {id: 'module2', name: 'LLM Triple Filtering', time: 2.1},
                {id: 'module3', name: 'Passage Ranking', time: 1.4},
                {id: 'module4', name: 'Context Expansion', time: 1.2},
                {id: 'module5', name: 'Answer Generation', time: 3.9}
            ];

            let currentModule = 0;
            let elapsedTime = 0;

            function processNextModule() {
                if (currentModule >= modules.length || !isProcessing) {
                    updateProgress(100);
                    return;
                }

                const module = modules[currentModule];
                updateModuleStatus(module.id, 'active', `Processing ${module.name}...`);

                setTimeout(() => {
                    if (isProcessing) {
                        updateModuleStatus(module.id, 'completed', `Completed (${module.time}s)`);
                        elapsedTime += module.time;
                        updateProgress(((currentModule + 1) / modules.length) * 100);
                        
                        document.getElementById('elapsed-time').textContent = `⏱️ Elapsed: ${elapsedTime.toFixed(1)}s`;
                        
                        currentModule++;
                        processNextModule();
                    }
                }, module.time * 200); // Speed up for demo
            }

            processNextModule();
        }

        function resetModuleStates() {
            const modules = ['module1', 'module2', 'module3', 'module4', 'module5'];
            modules.forEach(id => {
                const element = document.getElementById(id);
                element.classList.remove('active', 'completed');
                element.querySelector('.module-status').textContent = 'Waiting...';
            });
            updateProgress(0);
        }

        function updateModuleStatus(moduleId, status, message) {
            const element = document.getElementById(moduleId);
            element.classList.remove('active', 'completed');
            
            if (status === 'active') {
                element.classList.add('active');
            } else if (status === 'completed') {
                element.classList.add('completed');
            }
            
            element.querySelector('.module-status').textContent = message;
        }

        function updateProgress(percentage) {
            const progressFill = document.getElementById('progress-fill');
            const progressText = document.getElementById('progress-text');
            
            progressFill.style.width = percentage + '%';
            progressText.textContent = `Overall Progress: ${Math.round(percentage)}%`;
        }

        function cancelProcessing() {
            isProcessing = false;
            processBtn.disabled = false;
            
            if (processingWebSocket) {
                processingWebSocket.close();
            }
            
            showView('main');
        }

        function displayResults(result) {
            // Store for detailed view
            currentDetailedResults = result;

            if (!result.success) {
                showError(result.error || 'Processing failed');
                showView('main');
                return;
            }

            // Update processing time
            document.getElementById('processing-time').textContent = 
                `✅ Processing completed in ${result.processing_time?.toFixed(1) || 'unknown'}s`;

            // Update answer
            const answerText = document.getElementById('answer-text');
            const qualityScore = document.getElementById('quality-score');
            const confidenceScore = document.getElementById('confidence-score');

            if (result.module5_results?.answer_details) {
                const answer = result.module5_results.answer_details;
                answerText.innerHTML = answer.ai_answer || 'No answer generated';
                qualityScore.textContent = answer.quality_score?.toFixed(1) || 'N/A';
                confidenceScore.textContent = answer.confidence_score ? 
                    Math.round(answer.confidence_score) + '%' : 'N/A';
            } else {
                answerText.innerHTML = 'Answer generation not available in this response';
                qualityScore.textContent = 'N/A';
                confidenceScore.textContent = 'N/A';
            }

            // Update passages
            const passagesContainer = document.getElementById('passages-container');
            passagesContainer.innerHTML = '';

            if (result.final_results?.final_passages) {
                result.final_results.final_passages.forEach((passage, index) => {
                    const medals = ['🏆', '🥈', '🥉'];
                    const medal = medals[index] || '📄';
                    
                    const passageElement = document.createElement('div');
                    passageElement.className = 'passage-item';
                    passageElement.innerHTML = `
                        <div class="passage-header">
                            <div class="passage-rank">${medal} #${passage.rank || index + 1} - ${passage.passage_id}</div>
                            <div class="passage-score">${passage.final_score?.toFixed(3) || 'N/A'}</div>
                        </div>
                        <div class="passage-text">${passage.text_preview || 'No preview available'}</div>
                        <div class="passage-meta">📍 ${passage.supporting_triples_count || 0} supporting knowledge triples</div>
                    `;
                    passagesContainer.appendChild(passageElement);
                });
            } else {
                passagesContainer.innerHTML = '<p>No passages available in this response</p>';
            }

            showView('results');
        }

        function showDetailedResults() {
            if (!currentDetailedResults) {
                alert('No detailed results available');
                return;
            }
            
            // Show detailed view
            showView('detailed');
            
            // Populate detailed results
            populateModuleDetails(currentDetailedResults);
        }

        function toggleModule(moduleId) {
            const element = document.getElementById(moduleId + '-details');
            element.classList.toggle('show');
        }

        function populateModuleDetails(result) {
            // Module 1 Details
            if (result.module1_results) {
                populateModule1Details(result.module1_results);
            }
            
            // Module 2 Details
            if (result.module2_results) {
                populateModule2Details(result.module2_results);
            }
            
            // Module 3 Details
            if (result.module3_results) {
                populateModule3Details(result.module3_results);
            }
            
            // Module 5 Details
            if (result.module5_results) {
                populateModule5Details(result.module5_results);
            }
        }

        function populateModule1Details(module1) {
            // Stats
            const statsContainer = document.getElementById('module1-stats');
            if (module1.stats) {
                statsContainer.innerHTML = `
                    <div class="stat-item">
                        <div class="stat-value">${module1.stats.passages_count || 0}</div>
                        <div class="stat-label">Passages Retrieved</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${module1.stats.triples_count || 0}</div>
                        <div class="stat-label">Triples Retrieved</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${module1.stats.avg_passage_score || 0}</div>
                        <div class="stat-label">Avg Passage Score</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${module1.stats.retrieval_time || 0}s</div>
                        <div class="stat-label">Retrieval Time</div>
                    </div>
                `;
            }
            
            // Passages
            const passagesContainer = document.getElementById('module1-passages');
            if (module1.top_passages) {
                passagesContainer.innerHTML = module1.top_passages.map(passage => `
                    <div class="data-item">
                        <div class="data-item-header">
                            ${passage.passage_id} - Score: ${passage.hybrid_score}
                        </div>
                        <div class="data-item-content">
                            ${passage.text_preview}<br>
                            <small>BM25: ${passage.bm25_score} | Embedding: ${passage.embedding_score}</small>
                        </div>
                    </div>
                `).join('');
            }
            
            // Triples
            const triplesContainer = document.getElementById('module1-triples');
            if (module1.top_triples) {
                triplesContainer.innerHTML = module1.top_triples.map(triple => `
                    <div class="data-item">
                        <div class="data-item-header">
                            ${triple.subject} → ${triple.predicate} → ${triple.object}
                        </div>
                        <div class="data-item-content">
                            Score: ${triple.hybrid_score} | Confidence: ${triple.confidence}<br>
                            <small>Source: ${triple.source_passage_id}</small>
                        </div>
                    </div>
                `).join('');
            }
        }

        function populateModule2Details(module2) {
            // Stats
            const statsContainer = document.getElementById('module2-stats');
            if (module2.stats) {
                statsContainer.innerHTML = `
                    <div class="stat-item">
                        <div class="stat-value">${module2.stats.original_count || 0}</div>
                        <div class="stat-label">Original Triples</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${module2.stats.filtered_count || 0}</div>
                        <div class="stat-label">Filtered Triples</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${((module2.stats.filtering_efficiency || 0) * 100).toFixed(1)}%</div>
                        <div class="stat-label">Filtering Efficiency</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${module2.stats.filtering_time || 0}s</div>
                        <div class="stat-label">Filtering Time</div>
                    </div>
                `;
            }
            
            // Filtered Triples
            const triplesContainer = document.getElementById('module2-triples');
            if (module2.filtered_triples) {
                triplesContainer.innerHTML = module2.filtered_triples.map(triple => `
                    <div class="data-item">
                        <div class="data-item-header">
                            ${triple.subject} → ${triple.predicate} → ${triple.object}
                        </div>
                        <div class="data-item-content">
                            Relevance: ${triple.relevance_score} (${triple.relevance_level})<br>
                            Quality: ${triple.quality_score} | Confidence: ${triple.confidence_score}<br>
                            <small>${triple.explanation}</small>
                        </div>
                    </div>
                `).join('');
            }
        }

        function populateModule3Details(module3) {
            // Stats
            const statsContainer = document.getElementById('module3-stats');
            if (module3.stats) {
                statsContainer.innerHTML = `
                    <div class="stat-item">
                        <div class="stat-value">${module3.stats.final_passage_count || 0}</div>
                        <div class="stat-label">Final Passages</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${module3.stats.avg_final_score || 0}</div>
                        <div class="stat-label">Avg Final Score</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${module3.stats.max_final_score || 0}</div>
                        <div class="stat-label">Max Final Score</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${module3.stats.ranking_time || 0}s</div>
                        <div class="stat-label">Ranking Time</div>
                    </div>
                `;
            }
            
            // Ranked Passages
            const passagesContainer = document.getElementById('module3-passages');
            if (module3.ranked_passages) {
                passagesContainer.innerHTML = module3.ranked_passages.map(passage => `
                    <div class="data-item">
                        <div class="data-item-header">
                            #${passage.rank} - ${passage.passage_id} (Score: ${passage.final_score})
                        </div>
                        <div class="data-item-content">
                            ${passage.text_preview}<br>
                            <small>
                                Retrieval: ${passage.hybrid_retrieval_score} | 
                                Support: ${passage.support_score} | 
                                Supporting Triples: ${passage.supporting_triples_count}
                            </small>
                        </div>
                    </div>
                `).join('');
            }
        }

        function populateModule5Details(module5) {
            // Stats
            const statsContainer = document.getElementById('module5-stats');
            if (module5.stats) {
                statsContainer.innerHTML = `
                    <div class="stat-item">
                        <div class="stat-value">${module5.stats.quality_score || 0}</div>
                        <div class="stat-label">Quality Score</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${module5.stats.confidence_score || 0}</div>
                        <div class="stat-label">Confidence Score</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${module5.stats.generation_time || 0}s</div>
                        <div class="stat-label">Generation Time</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${module5.stats.llm_provider || 'N/A'}</div>
                        <div class="stat-label">LLM Provider</div>
                    </div>
                `;
            }
            
            // Generation Details
            const detailsContainer = document.getElementById('module5-details-content');
            if (module5.answer_details) {
                detailsContainer.innerHTML = `
                    <div class="data-item">
                        <div class="data-item-header">Generated Answer</div>
                        <div class="data-item-content">${module5.answer_details.ai_answer}</div>
                    </div>
                    <div class="data-item">
                        <div class="data-item-header">Supporting Passages</div>
                        <div class="data-item-content">${module5.answer_details.supporting_passages_ids?.join(', ') || 'None'}</div>
                    </div>
                    <div class="data-item">
                        <div class="data-item-header">Supporting Triples</div>
                        <div class="data-item-content">${module5.answer_details.supporting_triples_ids?.join(', ') || 'None'}</div>
                    </div>
                `;
            }
        }

        function showError(message) {
            const errorContainer = document.getElementById('error-container');
            errorContainer.innerHTML = `
                <div class="error-message">
                    ❌ ${message}
                </div>
            `;
            setTimeout(() => {
                errorContainer.innerHTML = '';
            }, 5000);
        }

        function saveResults() {
            const results = {
                query: currentQuery,
                timestamp: new Date().toISOString(),
                answer: document.getElementById('answer-text').innerHTML,
                quality_score: document.getElementById('quality-score').textContent,
                confidence: document.getElementById('confidence-score').textContent,
                processing_time: document.getElementById('processing-time').textContent,
                detailed_results: currentDetailedResults
            };
            
            const dataStr = JSON.stringify(results, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `ppdx-results-${Date.now()}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            alert('Results saved successfully!');
        }

        // Global function for sample questions
        window.selectSampleQuestion = selectSampleQuestion;
    </script>
</body>
</html>
